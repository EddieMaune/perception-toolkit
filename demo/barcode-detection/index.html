<!--
  @license
  Copyright (c) 2019 The Polymer Project Authors. All rights reserved.
  This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
  The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
  The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
  Code distributed by Google as part of the polymer project is also
  subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="theme-color" content="#1A3230">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Toolkit - Barcode Detection</title>

    <style>
      html, body {
        background: rgb(40, 74, 72);
        width: 100%;
        height: 100%;
      }

      body {
        padding: 0;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #container {
        position: fixed;
        width: 100%;
        height: 100%;
        padding: 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        box-sizing: border-box;
        z-index: 1;
        pointer-events: none;
      }

      #get-started {
        display: none;
        padding: 8px 12px;
        background: #FFF;
        border: none;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.4);
        border-radius: 3px;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        cursor: pointer;
      }

      #get-started.visible {
        display: block;
      }

      dot-loader {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      no-support-card {
        opacity: 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.3s cubic-bezier(0, 0, 0.3, 1) forwards 0.2s;
      }

      data-card {
        margin-top: 16px;
        pointer-events: auto;
      }

      onboarding-card {
        --background: #82C4CA;
        --buttonActiveColor: #323662;
        --buttonHoverColor: #323662c8;
        --buttonInactiveColor: #32366294;
        --buttonBottomMargin: 12px;
        --padding: 0 0 36px 0;
        --contentBorderRadius: 4px 4px 0 0;
        opacity: 0;
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.3s cubic-bezier(0, 0, 0.3, 1) forwards 0.2s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }

        to {
          opacity: 1;
        }
      }
    </style>

    <script>
      window.WebComponents = window.WebComponents || {};
      window.WebComponents.root = '/node_modules/@webcomponents/webcomponentsjs/';
    </script>
    <script src="/node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  </head>
<body>
  <div id="container"></div>

  <!-- Step 1: Get the loader-->
  <script src="/lib/bundled/barcode-detection/loader.min.js"></script>
  <script>
    // Step 2: Show the loader.
    (function() {
      const { showLoader } = window.Toolkit.loader;
      showLoader();
    })();
  </script>

  <!-- Step 3: Get the required code for device support and onboarding -->
  <script src="/lib/bundled/barcode-detection/device-support.min.js"></script>
  <script src="/lib/bundled/barcode-detection/onboarding.min.js"></script>
  <script src="/third_party/idb-keyval/idb-keyval-iife.min.js"></script>

  <script>
    // Step 4: Destructure and initialize the toolkit.
    (async function() {
      const { hideLoader, showLoader, injectScript } = window.Toolkit.loader;
      const { startOnboardingProcess } = window.Toolkit.onboarding;
      const { detectSupport } = window.Toolkit.deviceSupport;

      const getStarted = document.body.querySelector('button#get-started');

      let loadMain;
      /**
       * Initialize the experience.
       */
      async function initializeExperience() {
        hideLoader();

        // Recall whether the user has done onboarding before.
        const onboarded = await idbKeyval.get('onboarded');
        if (!onboarded) {
          await startOnboardingProcess([
            '/demo/images/step1.jpg',
            '/demo/images/step2.jpg',
            '/demo/images/step3.jpg'
          ]);

          // Store for next time.
          await idbKeyval.set('onboarded', true);
        }

        // Load the main experience if necessary.
        if (!loadMain) {
          loadMain =
              await injectScript('/lib/bundled/barcode-detection/main.min.js');
        }

        const { initialize } = window.Toolkit.main;
        initialize();
      }

      try {
        const supported = await detectSupport();
        if (!supported) {
          return;
        }

        hideLoader();
        getStarted.classList.add('visible');

        // When getStarted is clicked, load the experience.
        getStarted.addEventListener('click', (e) => {
          showLoader();
          getStarted.classList.remove('visible');
          initializeExperience();
        });

        // When captureclose is fired, show the button again.
        window.addEventListener('captureclose', () => {
          getStarted.classList.add('visible');
        });
      } catch (e) {
        console.error(e);
      }
    })();
  </script>

  <button id="get-started">Get started</button>
</body>
</html>
